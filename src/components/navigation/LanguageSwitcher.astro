---
import { languages, type Language, getLangFromUrl } from '@i18n/utils';

interface Props {
  lang: Language;
}

const { lang } = Astro.props;
const currentLang = getLangFromUrl(Astro.url);

// Remove language prefix from path
let currentPath = Astro.url.pathname;
// Remove any language prefix (including 'en' if present)
Object.keys(languages).forEach((locale) => {
  if (currentPath.startsWith(`/${locale}/`)) {
    currentPath = currentPath.substring(locale.length + 1);
  } else if (currentPath === `/${locale}`) {
    currentPath = '/';
  }
});

// Remove leading slash if it's not root
if (currentPath !== '/' && currentPath.startsWith('/')) {
  currentPath = currentPath.substring(1);
}
---

<div class="relative">
  <button
    id="language-button"
    class="flex items-center gap-1 rounded-lg px-3 py-2 text-sm font-medium transition-colors hover:bg-gray-100 dark:hover:bg-gray-800"
    aria-label="Select language"
  >
    <span class="uppercase">{currentLang}</span>
    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"
      ></path>
    </svg>
  </button>

  <div
    id="language-menu"
    class="absolute right-0 mt-2 hidden w-48 rounded-lg border border-gray-200 bg-white py-2 shadow-lg dark:border-gray-800 dark:bg-black"
  >
    {
      Object.entries(languages).map(([code, name]) => {
        const path = currentPath === '/' ? '' : currentPath;
        const href = code === 'en' ? `/${path}` : `/${code}/${path}`;
        return (
          <a
            href={href}
            class:list={[
              'block px-4 py-2 text-sm transition-colors hover:bg-gray-100 dark:hover:bg-gray-800',
              { 'font-bold text-blue-600': code === currentLang },
            ]}
          >
            {name}
          </a>
        );
      })
    }
  </div>
</div>

<script>
  function initLanguageSwitcher() {
    const languageButton = document.getElementById('language-button');
    const languageMenu = document.getElementById('language-menu');

    if (!languageButton || !languageMenu) return;

    // Remove existing listeners by cloning
    const newButton = languageButton.cloneNode(true) as HTMLElement;
    languageButton.parentNode?.replaceChild(newButton, languageButton);

    const button = document.getElementById('language-button');
    const menu = document.getElementById('language-menu');

    button?.addEventListener('click', (e) => {
      e.stopPropagation();
      menu?.classList.toggle('hidden');
    });

    // Close menu when clicking outside
    document.addEventListener('click', () => {
      menu?.classList.add('hidden');
    });
  }

  // Initialize on page load
  initLanguageSwitcher();

  // Reinitialize after view transitions
  document.addEventListener('astro:page-load', initLanguageSwitcher);
</script>
